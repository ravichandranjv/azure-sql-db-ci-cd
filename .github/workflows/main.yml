name: Deploy Database
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Shell Cmd
      run: echo "{ConnectionString}=${{ secrets.AZURE_SQL_CONNECTION_STRING }}" >> $GITHUB_ENV
      shell: bash
    - name: Checkout Repo
      uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1.4.0
      with:
        dotnet-version: '3.1.100' 
    - name: Restore dependencies 
      working-directory: db-deploy
      run: dotnet restore      
    - name: Deploy
      working-directory: db-deploy
    - name: Set the value
      id: step_one
      run: |
        echo "Connection string " >> $GITHUB_ENV
        run: dotnet run
  Test:
    runs-on: ubuntu-latest
    needs: [Deploy]
    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1.4.0
      with:
        dotnet-version: '3.1.100' 
    - name: Restore dependencies 
      working-directory: db-test
      run: dotnet restore      
    - name: Run Tests
      working-directory: db-test        
      run: dotnet test
      
      
